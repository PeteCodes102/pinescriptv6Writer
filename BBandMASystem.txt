
//@version=6
strategy("BB & MA Crossover System with Trailing SL", 
         overlay=true, 
         initial_capital=10000, 
         default_qty_type=strategy.percent_of_equity, 
         default_qty_value=10,
         commission_type=strategy.commission.percent,
         commission_value=0.1,
         slippage=2)

// ============================================================================
// TRADING SESSION MANAGER - Power Tool Snippet
// ============================================================================
// Description: Manages trading sessions based on time and day of week
// Format: "HHMM-HHMM:123456" where HHMM is time in 24hr format
//         and 123456 represents days (1=Sun, 2=Mon, 3=Tue, 4=Wed, 5=Thu, 6=Fri, 7=Sat)
// Example: "0930-1630:23456" = 9:30 AM to 4:30 PM, Mon-Fri
//
// INTEGRATION:
// 1. Copy this entire section into your strategy
// 2. Add 'and session_active' to your entry conditions
// 3. Add force close logic: if force_close_now strategy.close_all()
// ============================================================================

// --- SESSION INPUTS ---
use_session = input.bool(false, "Use Session Filter", group="Session Manager")
session_string = input.string("0930-1630:23456", "Trading Session", 
                              tooltip="Format: HHMM-HHMM:123456 e.g., 0930-1630:23456 = 9:30-16:30, Mon-Fri", 
                              group="Session Manager")
force_close_time = input.string("", "Force Close Time (HHMM)", 
                                tooltip="Close all positions at this time. Leave empty to disable.", 
                                group="Session Manager")

// --- SESSION PARSING FUNCTIONS ---
// Parse start time (HHMM from before the dash)
parse_start_hour() =>
    int(str.tonumber(str.substring(session_string, 0, 2)))

parse_start_minute() =>
    int(str.tonumber(str.substring(session_string, 2, 4)))

// Parse end time (HHMM after the dash, before the colon)
parse_end_hour() =>
    dash_pos = str.pos(session_string, "-")
    int(str.tonumber(str.substring(session_string, dash_pos + 1, dash_pos + 3)))

parse_end_minute() =>
    dash_pos = str.pos(session_string, "-")
    int(str.tonumber(str.substring(session_string, dash_pos + 3, dash_pos + 5)))

// Parse allowed days (after the colon)
parse_days() =>
    colon_pos = str.pos(session_string, ":")
    str.substring(session_string, colon_pos + 1)

// Check if current day is allowed
is_day_allowed() =>
    days_str = parse_days()
    current_day = str.tostring(dayofweek)
    str.contains(days_str, current_day)

// Check if current time is within session
is_time_in_session() =>
    start_h = parse_start_hour()
    start_m = parse_start_minute()
    end_h = parse_end_hour()
    end_m = parse_end_minute()
    
    current_time = hour * 100 + minute
    start_time = start_h * 100 + start_m
    end_time = end_h * 100 + end_m
    
    // Handle sessions that cross midnight (e.g., 2200-0600 = 10 PM to 6 AM next day)
    if end_time < start_time
        current_time >= start_time or current_time <= end_time
    else
        current_time >= start_time and current_time <= end_time

// --- SESSION STATE VARIABLES ---
session_active = use_session ? (is_day_allowed() and is_time_in_session()) : true

// --- FORCE CLOSE CHECK ---
is_force_close_time() =>
    if force_close_time != "" and str.length(force_close_time) == 4
        force_h = int(str.tonumber(str.substring(force_close_time, 0, 2)))
        force_m = int(str.tonumber(str.substring(force_close_time, 2, 4)))
        hour == force_h and minute == force_m
    else
        false

force_close_now = use_session and is_force_close_time()

// --- USAGE IN YOUR STRATEGY ---
// Add 'and session_active' to your entry conditions:
//   if long_condition and session_active
//       strategy.entry("Long", strategy.long)
//
// Add force close logic after your entries:
//   if force_close_now
//       strategy.close_all("Force Close")
//
// ============================================================================
// END OF TRADING SESSION MANAGER
// ============================================================================


// ============================================================================
// INPUTS
// ============================================================================

// Bollinger Bands Settings
bb_length = input.int(20, "BB Length", minval=1, group="Bollinger Bands")
bb_mult = input.float(2.0, "BB Multiplier", minval=0.1, step=0.1, group="Bollinger Bands")

// Moving Average Settings
fast_ma_length = input.int(9, "Fast MA Length", minval=1, group="Moving Averages")
slow_ma_length = input.int(21, "Slow MA Length", minval=1, group="Moving Averages")
ma_type = input.string("EMA", "MA Type", options=["SMA", "EMA"], group="Moving Averages")

// ATR Settings for TP/SL
atr_length = input.int(14, "ATR Length", minval=1, group="Risk Management")
atr_sl_mult = input.float(1.5, "ATR SL Multiplier", minval=0.1, step=0.1, group="Risk Management")
atr_tp_mult = input.float(2.5, "ATR TP Multiplier", minval=0.1, step=0.1, group="Risk Management")

// Trailing Stop Settings
trail_activation_mult = input.float(1.0, "Trail Activation (ATR)", minval=0.1, step=0.1, group="Trailing Stop")
trail_offset_mult = input.float(0.75, "Trail Offset (ATR)", minval=0.1, step=0.1, group="Trailing Stop")

// Hard Stop Settings
use_hard_stop = input.bool(false, "Use Hard Stop Loss", group="Risk Management")
hard_stop_percent = input.float(2.0, "Hard Stop Loss %", minval=0.1, step=0.1, group="Risk Management", tooltip="Hard stop loss as percentage of entry price")

// Confluence Filters
use_volume_filter = input.bool(true, "Use Volume Filter", group="Confluence Filters")
volume_ma_length = input.int(20, "Volume MA Length", minval=1, group="Confluence Filters")
use_trend_filter = input.bool(true, "Use Trend Filter (200 MA)", group="Confluence Filters")
trend_ma_length = input.int(200, "Trend MA Length", minval=1, group="Confluence Filters")

// ============================================================================
// INDICATOR CALCULATIONS
// ============================================================================

// Bollinger Bands
[bb_middle, bb_upper, bb_lower] = ta.bb(close, bb_length, bb_mult)

// Moving Averages
fast_ma = ma_type == "EMA" ? ta.ema(close, fast_ma_length) : ta.sma(close, fast_ma_length)
slow_ma = ma_type == "EMA" ? ta.ema(close, slow_ma_length) : ta.sma(close, slow_ma_length)

// Trend Filter - 200 period MA
trend_ma = ta.sma(close, trend_ma_length)

// ATR for dynamic TP/SL
atr = ta.atr(atr_length)

// Volume Analysis
volume_ma = ta.sma(volume, volume_ma_length)
volume_surge = volume > volume_ma * 1.2

// ============================================================================
// ENTRY CONDITIONS
// ============================================================================

// MA Crossover Signals
ma_bullish_cross = ta.crossover(fast_ma, slow_ma)
ma_bearish_cross = ta.crossunder(fast_ma, slow_ma)

// Bollinger Band Position
price_above_bb_middle = close > bb_middle
price_below_bb_middle = close < bb_middle
bb_squeeze = (bb_upper - bb_lower) / bb_middle < 0.02 // Narrow bands indicate potential breakout

// BB Bounce Conditions
bb_lower_touch = low <= bb_lower and close > bb_lower
bb_upper_touch = high >= bb_upper and close < bb_upper

// BB Breakout Conditions  
bb_upper_breakout = close > bb_upper and close[1] <= bb_upper[1]
bb_lower_breakout = close < bb_lower and close[1] >= bb_lower[1]

// Trend Filter
bullish_trend = use_trend_filter ? close > trend_ma : true
bearish_trend = use_trend_filter ? close < trend_ma : true

// Volume Filter
volume_confirmed = use_volume_filter ? volume_surge : true

// ============================================================================
// LONG ENTRY CONFLUENCES
// ============================================================================

// Strategy 1: MA Cross + BB Middle Support
long_signal_1 = ma_bullish_cross and price_above_bb_middle and bullish_trend and volume_confirmed

// Strategy 2: BB Lower Band Bounce + Fast MA Above Slow MA  
long_signal_2 = bb_lower_touch and fast_ma > slow_ma and bullish_trend and volume_confirmed

// Strategy 3: BB Breakout Confirmation with MA Alignment
long_signal_3 = bb_upper_breakout and fast_ma > slow_ma and bullish_trend and volume_confirmed

// Combined Long Entry
long_entry = (long_signal_1 or long_signal_2 or long_signal_3) and session_active

// ============================================================================
// SHORT ENTRY CONFLUENCES
// ============================================================================

// Strategy 1: MA Cross + BB Middle Resistance
short_signal_1 = ma_bearish_cross and price_below_bb_middle and bearish_trend and volume_confirmed

// Strategy 2: BB Upper Band Rejection + Fast MA Below Slow MA
short_signal_2 = bb_upper_touch and fast_ma < slow_ma and bearish_trend and volume_confirmed

// Strategy 3: BB Breakout Confirmation with MA Alignment  
short_signal_3 = bb_lower_breakout and fast_ma < slow_ma and bearish_trend and volume_confirmed

// Combined Short Entry
short_entry = (short_signal_1 or short_signal_2 or short_signal_3) and session_active

// ============================================================================
// EXIT SIGNALS
// ============================================================================

// Exit long position when short signals appear or opposite MA cross occurs
long_exit_signal = strategy.position_size > 0 and (short_signal_1 or short_signal_2 or short_signal_3 or ma_bearish_cross)

// Exit short position when long signals appear or opposite MA cross occurs  
short_exit_signal = strategy.position_size < 0 and (long_signal_1 or long_signal_2 or long_signal_3 or ma_bullish_cross)

// ============================================================================
// POSITION SIZING & RISK MANAGEMENT
// ============================================================================

// Calculate SL and TP distances in ticks
atr_ticks = atr / syminfo.mintick
sl_distance_ticks = int(atr_sl_mult * atr_ticks)
tp_distance_ticks = int(atr_tp_mult * atr_ticks)

// Calculate trailing stop parameters in ticks
trail_activation_ticks = int(trail_activation_mult * atr_ticks)
trail_offset_ticks = int(trail_offset_mult * atr_ticks)

// ============================================================================
// STRATEGY EXECUTION
// ============================================================================

// Track entry prices for visualization
var float long_entry_price = na
var float short_entry_price = na
var float long_sl_price = na
var float short_sl_price = na
var float long_tp_price = na
var float short_tp_price = na
var float hard_stop_price = na

// EXIT LOGIC - Process exits before entries to ensure proper position management

// Hard Stop Loss Check - Close all positions if hard stop is hit
if use_hard_stop and strategy.position_size != 0
    if strategy.position_size > 0 and close <= hard_stop_price
        strategy.close_all("Hard Stop Long")
    if strategy.position_size < 0 and close >= hard_stop_price
        strategy.close_all("Hard Stop Short")

// Exit signals - Close positions when opposite signals occur
if long_exit_signal
    strategy.close_all("Exit Long")

if short_exit_signal
    strategy.close_all("Exit Short")

// Force Close on Session End
if force_close_now
    strategy.close_all("Force Close")

// ENTRY LOGIC - Process entries after exits

// LONG ENTRIES
if long_entry and strategy.position_size == 0
    strategy.entry("Long", strategy.long, comment="Long Entry")
    
    // Calculate and store levels for visualization
    long_entry_price := close
    long_sl_price := close - atr_sl_mult * atr
    long_tp_price := close + atr_tp_mult * atr
    
    // Calculate hard stop if enabled
    if use_hard_stop
        hard_stop_price := close * (1 - hard_stop_percent / 100)
    
    // Exit strategy with trailing stop
    strategy.exit("Long Exit", "Long", 
                 profit=tp_distance_ticks,
                 loss=sl_distance_ticks,
                 trail_points=trail_activation_ticks,
                 trail_offset=trail_offset_ticks,
                 comment="Long Exit")

// SHORT ENTRIES  
if short_entry and strategy.position_size == 0
    strategy.entry("Short", strategy.short, comment="Short Entry")
    
    // Calculate and store levels for visualization
    short_entry_price := close
    short_sl_price := close + atr_sl_mult * atr
    short_tp_price := close - atr_tp_mult * atr
    
    // Calculate hard stop if enabled
    if use_hard_stop
        hard_stop_price := close * (1 + hard_stop_percent / 100)
    
    // Exit strategy with trailing stop
    strategy.exit("Short Exit", "Short",
                 profit=tp_distance_ticks,
                 loss=sl_distance_ticks, 
                 trail_points=trail_activation_ticks,
                 trail_offset=trail_offset_ticks,
                 comment="Short Exit")

// Reset price levels when position closes
if ta.change(strategy.position_size) == -strategy.position_size[1] or strategy.position_size == 0
    long_entry_price := na
    short_entry_price := na
    long_sl_price := na
    short_sl_price := na
    long_tp_price := na
    short_tp_price := na
    hard_stop_price := na

// ============================================================================
// VISUALIZATION
// ============================================================================

// Plot Bollinger Bands
p1 = plot(bb_upper, "BB Upper", color=color.new(color.blue, 50), linewidth=1)
p2 = plot(bb_lower, "BB Lower", color=color.new(color.blue, 50), linewidth=1)
p3 = plot(bb_middle, "BB Middle", color=color.new(color.gray, 30), linewidth=1)
fill(p1, p3, color=color.new(color.blue, 90), title="BB Upper Fill")
fill(p2, p3, color=color.new(color.blue, 90), title="BB Lower Fill")

// Plot Moving Averages
plot(fast_ma, "Fast MA", color=color.new(color.green, 0), linewidth=2)
plot(slow_ma, "Slow MA", color=color.new(color.red, 0), linewidth=2)
plot(use_trend_filter ? trend_ma : na, "Trend MA", color=color.new(color.orange, 30), linewidth=2)

// Plot Entry, SL, and TP levels
plot(strategy.position_size > 0 ? long_entry_price : na, "Long Entry", 
     color=color.new(color.green, 0), style=plot.style_linebr, linewidth=1)
plot(strategy.position_size > 0 ? long_sl_price : na, "Long SL", 
     color=color.new(color.red, 0), style=plot.style_linebr, linewidth=1)
plot(strategy.position_size > 0 ? long_tp_price : na, "Long TP", 
     color=color.new(color.lime, 0), style=plot.style_linebr, linewidth=1)

plot(strategy.position_size < 0 ? short_entry_price : na, "Short Entry", 
     color=color.new(color.red, 0), style=plot.style_linebr, linewidth=1)
plot(strategy.position_size < 0 ? short_sl_price : na, "Short SL", 
     color=color.new(color.green, 0), style=plot.style_linebr, linewidth=1)
plot(strategy.position_size < 0 ? short_tp_price : na, "Short TP", 
     color=color.new(color.maroon, 0), style=plot.style_linebr, linewidth=1)

// Plot Hard Stop level if enabled
plot(use_hard_stop and strategy.position_size != 0 ? hard_stop_price : na, "Hard Stop", 
     color=color.new(color.orange, 0), style=plot.style_linebr, linewidth=2)

// Plot Entry Signals
plotshape(long_entry, "Long Signal", shape.triangleup, location.belowbar, 
         color=color.new(color.green, 0), size=size.small)
plotshape(short_entry, "Short Signal", shape.triangledown, location.abovebar, 
         color=color.new(color.red, 0), size=size.small)

// Background colors for trend
bgcolor(bullish_trend and use_trend_filter ? color.new(color.green, 95) : na, title="Bullish Trend BG")
bgcolor(bearish_trend and use_trend_filter ? color.new(color.red, 95) : na, title="Bearish Trend BG")

// ============================================================================
// PERFORMANCE TABLE
// ============================================================================

var table perfTable = table.new(position.top_right, 2, 7, 
                                 bgcolor=color.new(color.black, 85), 
                                 border_width=1,
                                 border_color=color.gray)

if barstate.islastconfirmedhistory or barstate.isrealtime
    // Header
    table.cell(perfTable, 0, 0, "Metric", text_color=color.white, bgcolor=color.new(color.gray, 50))
    table.cell(perfTable, 1, 0, "Value", text_color=color.white, bgcolor=color.new(color.gray, 50))
    
    // Performance Metrics
    table.cell(perfTable, 0, 1, "Net Profit", text_color=color.white)
    table.cell(perfTable, 1, 1, str.tostring(strategy.netprofit, "#.##"), 
              text_color=strategy.netprofit >= 0 ? color.lime : color.red)
    
    table.cell(perfTable, 0, 2, "Total Trades", text_color=color.white)
    table.cell(perfTable, 1, 2, str.tostring(strategy.closedtrades), text_color=color.white)
    
    table.cell(perfTable, 0, 3, "Win Rate %", text_color=color.white)
    win_rate = strategy.closedtrades > 0 ? (strategy.wintrades / strategy.closedtrades) * 100 : 0
    table.cell(perfTable, 1, 3, str.tostring(win_rate, "#.##"), 
              text_color=win_rate >= 50 ? color.lime : color.red)
    
    table.cell(perfTable, 0, 4, "Profit Factor", text_color=color.white)
    profit_factor = strategy.grossloss != 0 ? math.abs(strategy.grossprofit / strategy.grossloss) : 0
    table.cell(perfTable, 1, 4, str.tostring(profit_factor, "#.##"), 
              text_color=profit_factor >= 1.5 ? color.lime : color.orange)
    
    table.cell(perfTable, 0, 5, "Max Drawdown", text_color=color.white)
    table.cell(perfTable, 1, 5, str.tostring(strategy.max_drawdown, "#.##"), text_color=color.red)
    
    table.cell(perfTable, 0, 6, "Open Position", text_color=color.white)
    pos_text = strategy.position_size > 0 ? "LONG" : strategy.position_size < 0 ? "SHORT" : "NONE"
    pos_color = strategy.position_size > 0 ? color.lime : strategy.position_size < 0 ? color.red : color.gray
    table.cell(perfTable, 1, 6, pos_text, text_color=pos_color)

// ============================================================================
// ALERTS
// ============================================================================

alertcondition(long_entry, "Long Entry Alert", "BB & MA System: Long Entry Signal")
alertcondition(short_entry, "Short Entry Alert", "BB & MA System: Short Entry Signal")
alertcondition(ta.change(strategy.closedtrades) == 1, "Trade Closed", "BB & MA System: Trade Closed")
